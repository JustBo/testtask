<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Title</title>
    <link rel="stylesheet" href="index.css">
</head>
<body>
<form id="form">
    <div>
        Sum:
        <input type="text" name="sum">
    </div>
    <div>
        Price:
        <input type="text" name="price">
    </div>
    <button>Calculate</button>
</form>
<script>
    let form = document.getElementById('form');
    form.addEventListener('submit', function (e) {
        e.preventDefault();
        let data = new FormData(form);
        console.log(data.get('sum'));
    })
</script>

<hr>

<div class="container" id="root"></div>

<script>
    (function () {
        let app = new App(document.getElementById('root'));

        function App(element) {
            this.render = function () {
                element.innerHTML = '';
                let app = element;

                let contactList = new ContactList();
                let contactAdd = new ContactAdd();
                let contactRemove = new ContactRemove();

                app.appendChild(contactList.render());
                app.appendChild(contactAdd.render());
                app.appendChild(contactRemove.render());
            };
            this.render();
        }

        App.render = function () {
            return app.render();
        };

        function ContactRemove() {
            this.contacts = localStorage.getItem('contacts') ? JSON.parse(localStorage.getItem('contacts')) : [];
            this.handleClick = function () {

                let checked = [];
                let checkboxes = document.querySelectorAll('.check-contact');
                for (let i = 0; i < checkboxes.length; i++) {
                    if(checkboxes.item(i).checked) {
                        checked.push(i);
                    }
                }

                let filteredContacts = [];
                let contacts = this.contacts;
                for (let key in contacts) {
                    if (checked.indexOf(Number(key)) === -1) {
                        filteredContacts.push(contacts[key]);
                    }
                }
                localStorage.setItem('contacts', JSON.stringify(filteredContacts));
                App.render();
            };

            this.render = function () {
                let that = this;
                let btn = document.createElement('button');
                btn.innerText = 'Delete';
                btn.addEventListener('click', function (e) {
                    that.handleClick();
                });
                return btn;
            };
        }

        function ContactAdd() {

            this.handleClick = function () {
                let modal = new Modal('testModal');
                let form = new ContactForm(modal);

                modal.setChildren(form);
                modal.open();
            };

            this.render = function () {
                let btnContainer = document.createElement('div');
                let btn = document.createElement('button');
                btn.innerText = 'Add';
                btn.addEventListener('click', this.handleClick);
                btnContainer.appendChild(btn);
                return btnContainer;
            };
        }

        function Modal(name) {
            this.name = name;
            this.children = document.createElement('div');
            this.setChildren = function (nodes) {
                this.children = nodes;
            };
            this.getChildren = function () {
                return this.children;
            };
            this.close = function () {
                let modal = document.getElementsByClassName(this.name).item(0);
                modal.classList.remove('animate-open');
                modal.classList.add('animate-close');
                setTimeout(function () {
                    document.getElementsByClassName('backdrop').item(0).remove();
                    modal.remove();
                }, 300);
            };
            this.open = function () {
                let that = this;
                let backdrop = document.createElement('div');
                backdrop.className = 'backdrop';

                backdrop.addEventListener('click', function () {
                    that.close();
                });

                let modal = document.createElement('div');
                modal.className = 'modal ' + this.name + ' ' + 'animate-open';
                modal.setAttribute('data-name', this.name);

                let closeBtn = document.createElement('div');
                closeBtn.className = 'close-btn';
                closeBtn.innerHTML = 'x';

                closeBtn.addEventListener('click', function () {
                    that.close();
                });

                modal.appendChild(closeBtn);
                modal.appendChild(this.getChildren());

                document.getElementsByTagName('body')[0].appendChild(backdrop);
                document.getElementsByTagName('body')[0].appendChild(modal);
            }
        }

        function ContactForm(modal, id = null) {
            this.id = id;
            this.contact = id === null ? null : JSON.parse(localStorage.getItem('contacts'))[id];
            this.inputs = {
                firstName: {
                    displayName: 'First Name',
                    type: 'text',
                    validate: {
                        required: true,
                        minLength: 3
                    },
                    value: this.contact === null ? '' : this.contact.firstName
                },
                lastName: {
                    displayName: 'Last Name',
                    type: 'text',
                    validate: {
                        required: true,
                        minLength: 3
                    },
                    value: this.contact === null ? '' : this.contact.lastName
                },
                email: {
                    displayName: 'E-mail',
                    type: 'email',
                    validate: {
                        required: true,
                        regex: /[a-z0-9!#$%&'*+/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?/
                    },
                    value: this.contact === null ? '' : this.contact.email
                },
            };
            this.modal = modal;
            this.getForm = function () {
                return document.getElementById('contact-form');
            };
            this.setErrors = function (errors) {
                // reset errors
                let errorContainers = document.querySelectorAll('.input-error');
                for (let i = 0; i < errorContainers.length; i++) {
                    errorContainers[i].innerText = '';
                }
                //set errors
                if (errors.length > 0) {
                    for (let i = 0; i < errors.length; i++) {
                        let errorContainer = document.querySelector('.input-error.' + errors[i].name);
                        errorContainer.innerText = errors[i].msg;
                    }
                }
            };
            this.validate = function () {
                let data = new FormData(this.getForm());
                let inputs = this.inputs;
                let errors = [];
                for (let name in inputs) {
                    let options = inputs[name];
                    let value = data.get(name);
                    if (options.validate) {
                        if (options.validate.required && value === '') {
                            errors.push({
                                'name': name,
                                'msg': options.displayName + ' is Required'
                            });
                            continue;
                        }
                        if (options.validate.minLength && value.length < options.validate.minLength) {
                            errors.push({
                                'name': name,
                                'msg': 'Enter ' + options.validate.minLength + ' or more characters'
                            });
                            continue;
                        }
                        if (options.validate.regex && !options.validate.regex.test(value)) {
                            errors.push({
                                'name': name,
                                'msg': 'Invalid ' + options.displayName
                            });
                            continue;
                        }
                    }
                }
                return errors;
            };
            this.handleSubmit = function (e) {
                e.preventDefault();
                let data = new FormData(this.getForm());
                let inputs = this.inputs;
                //validate
                let errors = this.validate();
                this.setErrors(errors);
                if (errors.length > 0) {
                    return;
                }
                // create new row
                let contacts = localStorage.getItem('contacts');
                let rows = contacts ? JSON.parse(contacts) : [];
                let contact = {
                    'date': new Date()
                };
                for (let name in inputs) {
                    contact[name] = data.get(name);
                }
                if (this.id === null) {
                    rows.push(contact);
                } else {
                    rows[this.id] = contact;
                }
                localStorage.setItem('contacts', JSON.stringify(rows));
                this.modal.close();
                App.render();
            };
            this.render = function () {
                const inputs = this.inputs;
                let form = document.createElement('form');
                form.setAttribute('id', 'contact-form');
                for (let name in inputs) {
                    let container = document.createElement('div');

                    let label = document.createElement('label');
                    label.innerText = inputs[name].displayName;
                    container.appendChild(label);

                    let input = document.createElement('input');
                    input.setAttribute('type', inputs[name].type);
                    input.setAttribute('name', name);
                    input.setAttribute('value', inputs[name].value);
                    container.appendChild(input);

                    let errorContainer = document.createElement('div');
                    errorContainer.className = 'input-error ' + name;
                    container.appendChild(errorContainer);

                    form.appendChild(container);
                }
                let btn = document.createElement('button');
                btn.innerText = 'Save';
                form.appendChild(btn);
                let that = this;
                form.addEventListener('submit', function (e) {
                    that.handleSubmit(e);
                });
                return form;
            };
            return this.render();
        }

        function ContactList() {
            let contactsStorage = localStorage.getItem('contacts');
            this.fields = {
                firstName: "First Name",
                lastName: 'Last Name',
                email: 'E-mail',
            };
            this.contacts = contactsStorage ? JSON.parse(contactsStorage) : [];
            this.handleClick = function (id) {
                let modal = new Modal('testModal');
                let form = new ContactForm(modal, id);

                modal.setChildren(form);
                modal.open();
            };

            this.render = function (rows = null) {
                const fields = this.fields;
                let that = this;
                let table = document.createElement('table');
                let header = document.createElement('tr');
                let checkbox = document.createElement('input');
                checkbox.setAttribute('type', 'checkbox');
                checkbox.id = 'select-checkbox';
                checkbox.addEventListener('click', function (e) {
                    let checkboxes = document.querySelectorAll('.check-contact');
                    for (let key in checkboxes) {
                        checkboxes.item(key).checked = e.target.checked;
                    }
                    that.checked = e.target.checked ? Object.keys(that.contacts) : [];

                    // console.log(that.checked);
                });
                header.appendChild(document.createElement('td').appendChild(checkbox));
                for (let name in fields) {
                    let col = document.createElement('th');
                    col.innerText = fields[name];
                    header.appendChild(col);
                }
                table.appendChild(header);
                // generate rows
                let contacts = rows === null ? this.contacts : rows;
                for (let id in contacts) {
                    let row = document.createElement('tr');
                    let checkbox = document.createElement('input');
                    checkbox.setAttribute('type', 'checkbox');
                    checkbox.className = 'check-contact';

                    checkbox.addEventListener('click', function() {
                        let selectAll = document.getElementById('select-checkbox');
                        selectAll.checked = false;
                    });

                    row.appendChild(document.createElement('td').appendChild(checkbox));
                    for (let name in fields) {
                        let col = document.createElement('td');
                        col.innerText = contacts[id][name];
                        row.appendChild(col);
                    }
                    row.addEventListener('click', function () {
                        that.handleClick(id);
                    });
                    table.appendChild(row);
                }
                return table;
            };
        }
    })();


</script>


</body>
</html>